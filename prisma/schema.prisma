// Prisma schema for GradeDescent backend
generator client {
  provider = "prisma-client-js"
  // Explicit output path required for Prisma 7+; use .prisma forwarder
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  OWNER
  INSTRUCTOR
  TA
  STUDENT
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubmissionStatus {
  UPLOADING
  SUBMITTED
  PROCESSING
  READY
  FAILED
}

enum ArtifactKind {
  PDF
  TEX
}

enum ArtifactStorage {
  S3
  DB
}

enum ArtifactOrigin {
  UPLOAD
  DERIVED
}

enum EvaluationStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  emailVerifiedAt DateTime?
  name            String?
  pictureUrl      String?
  passwordHash    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  accounts        OAuthAccount[]
  memberships     CourseMembership[]
  magicTokens     MagicLinkToken[]
  createdCourses  Course[]           @relation("CourseOwner")
  serviceTokens   ServiceToken[]
  idempotencyKeys IdempotencyKey[]
  createdAssignments Assignment[]
  submissions     Submission[]
}

model OAuthAccount {
  id                String    @id @default(cuid())
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Course {
  id          String   @id @default(cuid())
  title       String
  code        String?  @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  owner       User     @relation("CourseOwner", fields: [createdById], references: [id])

  memberships CourseMembership[]
  assignments Assignment[]
  submissions Submission[]
}

model CourseMembership {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  role      Role
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId, role])
}

model MagicLinkToken {
  id         String    @id @default(cuid())
  userId     String?
  email      String
  token      String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model IdempotencyKey {
  id           String    @id @default(cuid())
  key          String    @unique
  userId       String?
  method       String
  path         String
  requestHash  String?
  statusCode   Int?
  responseBody Json?
  lockedAt     DateTime?
  createdAt    DateTime  @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model ServiceToken {
  id          String    @id @default(cuid())
  name        String
  tokenHash   String    @unique
  scopes      String[]
  createdById String
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  lastUsedAt  DateTime?

  createdBy User @relation(fields: [createdById], references: [id])
}

model Assignment {
  id          String           @id @default(cuid())
  courseId    String
  title       String
  dueAt       DateTime?
  totalPoints Int
  sourceTex   String
  status      AssignmentStatus @default(DRAFT)
  createdById String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  publishedAt DateTime?

  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdBy User  @relation(fields: [createdById], references: [id])

  submissions Submission[]

  @@index([courseId, status])
  @@index([courseId])
}

model Submission {
  id                    String           @id @default(cuid())
  assignmentId          String
  courseId              String
  userId                String
  number                Int
  status                SubmissionStatus @default(UPLOADING)
  primaryArtifactId     String?
  canonicalTexArtifactId String?
  createdAt             DateTime         @default(now())
  submittedAt           DateTime?
  errorMessage          String?

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  primaryArtifact     Artifact? @relation("PrimaryArtifact", fields: [primaryArtifactId], references: [id])
  canonicalTexArtifact Artifact? @relation("CanonicalTexArtifact", fields: [canonicalTexArtifactId], references: [id])

  artifacts   Artifact[]
  evaluations Evaluation[]

  @@unique([assignmentId, userId, number])
  @@index([assignmentId, userId])
  @@index([courseId, userId])
}

model Artifact {
  id          String          @id @default(cuid())
  submissionId String
  kind        ArtifactKind
  origin      ArtifactOrigin
  storage     ArtifactStorage
  sha256      String?
  sizeBytes   Int?
  contentType String?
  s3Bucket    String?
  s3Key       String?
  texBody     String?
  createdAt   DateTime        @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  primaryForSubmission   Submission[] @relation("PrimaryArtifact")
  canonicalForSubmission Submission[] @relation("CanonicalTexArtifact")

  @@index([submissionId])
}

model Evaluation {
  id          String           @id @default(cuid())
  submissionId String
  status      EvaluationStatus @default(QUEUED)
  model       String?
  scorePoints Int?
  scoreOutOf  Int?
  result      Json?
  createdAt   DateTime         @default(now())
  completedAt DateTime?
  errorMessage String?

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
}
