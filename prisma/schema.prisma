// Prisma schema for GradeDescent backend
generator client {
  provider = "prisma-client-js"
  // Explicit output path required for Prisma 7+; use .prisma forwarder
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  OWNER
  INSTRUCTOR
  TA
  STUDENT
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubmissionStatus {
  UPLOADING
  SUBMITTED
  PROCESSING
  READY
  FAILED
}

enum ArtifactKind {
  PDF
  TEX
}

enum ArtifactStorage {
  S3
  DB
}

enum ArtifactOrigin {
  UPLOAD
  DERIVED
}

enum EvaluationStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

enum AccountType {
  USER
  ORG
}

enum LedgerEntryType {
  CREDIT
  CHARGE
  REFUND
  ADJUSTMENT
}

enum BillingMetric {
  vision_page
  grade_problem
  split_tex
}

enum PipelineName {
  ASSIGNMENT_PROCESS
  SUBMISSION_PROCESS
}

enum PipelineStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
}

enum PipelineStepStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  SKIPPED
  CANCELED
}

enum PipelineArtifactDirection {
  INPUT
  OUTPUT
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  emailVerifiedAt DateTime?
  name            String?
  pictureUrl      String?
  passwordHash    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  accounts        OAuthAccount[]
  memberships     CourseMembership[]
  magicTokens     MagicLinkToken[]
  createdCourses  Course[]           @relation("CourseOwner")
  serviceTokens   ServiceToken[]
  idempotencyKeys IdempotencyKey[]
  createdAssignments Assignment[]
  submissions     Submission[]
  billingAccounts Account[]
  pipelineRunsCreated PipelineRun[] @relation("PipelineRunCreator")
}

model OAuthAccount {
  id                String    @id @default(cuid())
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Course {
  id          String   @id @default(cuid())
  title       String
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  owner       User     @relation("CourseOwner", fields: [createdById], references: [id])

  memberships CourseMembership[]
  assignments Assignment[]
  submissions Submission[]
  pipelineRuns PipelineRun[]
  billing     CourseBilling?
  usageEvents UsageEvent[]

  @@index([code])
}

model CourseMembership {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  role      Role
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId, role])
}

model MagicLinkToken {
  id         String    @id @default(cuid())
  userId     String?
  email      String
  token      String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model IdempotencyKey {
  id           String    @id @default(cuid())
  key          String    @unique
  userId       String?
  method       String
  path         String
  requestHash  String?
  statusCode   Int?
  responseBody Json?
  lockedAt     DateTime?
  createdAt    DateTime  @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model ServiceToken {
  id          String    @id @default(cuid())
  name        String
  tokenHash   String    @unique
  scopes      String[]
  createdById String
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  lastUsedAt  DateTime?

  createdBy User @relation(fields: [createdById], references: [id])
}

model Account {
  id          String      @id @default(cuid())
  type        AccountType
  ownerUserId String?
  name        String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  owner        User?             @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  balance      AccountBalance?
  courseLinks  CourseBilling[]
  ledgerEntries LedgerEntry[]
  usageEvents  UsageEvent[]
  pipelineRuns PipelineRun[]

  @@unique([type, ownerUserId])
}

model CourseBilling {
  courseId  String   @id
  accountId String
  createdAt DateTime @default(now())

  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

model AccountBalance {
  accountId            String   @id
  currency             String   @default("USD")
  balanceMicrodollars  BigInt
  updatedAt            DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model LedgerEntry {
  id                 String          @id @default(cuid())
  accountId          String
  currency           String
  type               LedgerEntryType
  amountMicrodollars BigInt
  relatedType        String?
  relatedId          String?
  idempotencyKey     String?
  meta               Json?
  createdAt          DateTime        @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, createdAt])
  @@index([relatedType, relatedId])
  @@index([accountId, idempotencyKey])
}

model RateCard {
  id                   String        @id @default(cuid())
  metric               BillingMetric
  unitPriceMicrodollars BigInt
  active               Boolean       @default(true)
  effectiveFrom        DateTime      @default(now())
  effectiveTo          DateTime?
  meta                 Json?

  @@index([metric, active, effectiveFrom])
}

model UsageEvent {
  id                   String        @id @default(cuid())
  accountId            String
  courseId             String
  metric               BillingMetric
  quantity             Int
  unitPriceMicrodollars BigInt
  costMicrodollars     BigInt
  assignmentId         String?
  submissionId         String?
  evaluationId         String?
  pipelineRunId        String?
  pipelineStepId       String?
  meta                 Json?
  createdAt            DateTime      @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignment Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  submission Submission? @relation(fields: [submissionId], references: [id], onDelete: SetNull)
  evaluation Evaluation? @relation(fields: [evaluationId], references: [id], onDelete: SetNull)
  pipelineRun PipelineRun? @relation(fields: [pipelineRunId], references: [id], onDelete: SetNull)
  pipelineStep PipelineStep? @relation(fields: [pipelineStepId], references: [id], onDelete: SetNull)

  @@index([accountId, createdAt])
  @@index([courseId, createdAt])
  @@index([metric])
}

model Assignment {
  id          String           @id @default(cuid())
  courseId    String
  title       String
  dueAt       DateTime?
  totalPoints Int
  sourceTex   String
  status      AssignmentStatus @default(DRAFT)
  createdById String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  publishedAt DateTime?

  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdBy User  @relation(fields: [createdById], references: [id])

  submissions Submission[]
  pipelineRuns PipelineRun[]
  problems AssignmentProblem[]
  usageEvents UsageEvent[]

  @@index([courseId, status])
  @@index([courseId])
}

model Submission {
  id                    String           @id @default(cuid())
  assignmentId          String
  courseId              String
  userId                String
  number                Int
  status                SubmissionStatus @default(UPLOADING)
  primaryArtifactId     String?
  canonicalTexArtifactId String?
  createdAt             DateTime         @default(now())
  submittedAt           DateTime?
  errorMessage          String?

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  primaryArtifact     Artifact? @relation("PrimaryArtifact", fields: [primaryArtifactId], references: [id])
  canonicalTexArtifact Artifact? @relation("CanonicalTexArtifact", fields: [canonicalTexArtifactId], references: [id])

  artifacts   Artifact[]
  evaluations Evaluation[]
  pipelineRuns PipelineRun[]
  problems SubmissionProblem[]
  usageEvents UsageEvent[]

  @@unique([assignmentId, userId, number])
  @@index([assignmentId, userId])
  @@index([assignmentId, userId, createdAt])
  @@index([courseId, userId])
}

model Artifact {
  id          String          @id @default(cuid())
  submissionId String
  kind        ArtifactKind
  origin      ArtifactOrigin
  storage     ArtifactStorage
  sha256      String?
  sizeBytes   Int?
  contentType String?
  s3Bucket    String?
  s3Key       String?
  texBody     String?
  createdAt   DateTime        @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  pipelineStepArtifacts PipelineStepArtifact[]

  primaryForSubmission   Submission[] @relation("PrimaryArtifact")
  canonicalForSubmission Submission[] @relation("CanonicalTexArtifact")

  @@index([submissionId])
}

model Evaluation {
  id          String           @id @default(cuid())
  submissionId String
  status      EvaluationStatus @default(QUEUED)
  model       String?
  scorePoints Int?
  scoreOutOf  Int?
  result      Json?
  createdAt   DateTime         @default(now())
  completedAt DateTime?
  errorMessage String?

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  pipelineRuns PipelineRun[]
  problemEvaluations ProblemEvaluation[]
  usageEvents UsageEvent[]

  @@index([submissionId])
}

model PipelineRun {
  id               String         @id @default(cuid())
  pipeline         PipelineName
  courseId         String
  accountId        String
  assignmentId     String?
  submissionId     String?
  evaluationId     String?
  status           PipelineStatus
  createdByUserId  String?
  createdByService String?
  idempotencyKey   String?
  startedAt        DateTime?
  finishedAt       DateTime?
  errorMessage     String?
  meta             Json           @default("{}")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  course     Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  account    Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  assignment Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  submission Submission? @relation(fields: [submissionId], references: [id], onDelete: SetNull)
  evaluation Evaluation? @relation(fields: [evaluationId], references: [id], onDelete: SetNull)
  createdBy  User?       @relation("PipelineRunCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  steps      PipelineStep[]
  usageEvents UsageEvent[]

  @@index([submissionId, createdAt])
  @@index([assignmentId, createdAt])
  @@index([courseId, pipeline, idempotencyKey])
}

model PipelineStep {
  id           String             @id @default(cuid())
  runId        String
  name         String
  status       PipelineStepStatus
  runAt        DateTime           @default(now())
  priority     Int                @default(0)
  attempt      Int                @default(0)
  maxAttempts  Int                @default(3)
  lockedBy     String?
  lockedUntil  DateTime?
  heartbeatAt  DateTime?
  startedAt    DateTime?
  finishedAt   DateTime?
  errorMessage String?
  meta         Json               @default("{}")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  run       PipelineRun         @relation(fields: [runId], references: [id], onDelete: Cascade)
  events    PipelineStepEvent[]
  artifacts PipelineStepArtifact[]
  usageEvents UsageEvent[]

  @@index([runAt, priority, id])
  @@index([lockedUntil])
  @@index([runId, status])
}

model PipelineStepArtifact {
  stepId     String
  artifactId String
  direction  PipelineArtifactDirection

  step     PipelineStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  artifact Artifact     @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@id([stepId, artifactId, direction])
}

model PipelineStepEvent {
  id        Int      @id @default(autoincrement())
  stepId    String
  level     String
  message   String
  meta      Json     @default("{}")
  createdAt DateTime @default(now())

  step PipelineStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId, id])
}

model AssignmentProblem {
  id           String   @id @default(cuid())
  assignmentId String
  problemIndex Int
  title        String?
  maxPoints    Int?
  promptTex    String?
  rubric       Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  evaluations ProblemEvaluation[]

  @@unique([assignmentId, problemIndex])
}

model SubmissionProblem {
  id           String   @id @default(cuid())
  submissionId String
  problemIndex Int
  sourceTex    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  evaluations ProblemEvaluation[]

  @@unique([submissionId, problemIndex])
}

model ProblemEvaluation {
  id                  String   @id @default(cuid())
  evaluationId        String
  submissionProblemId String
  assignmentProblemId String?
  score               Int?
  evaluationJson      Json     @default("{}")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  evaluation        Evaluation         @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  submissionProblem SubmissionProblem @relation(fields: [submissionProblemId], references: [id], onDelete: Cascade)
  assignmentProblem AssignmentProblem? @relation(fields: [assignmentProblemId], references: [id], onDelete: SetNull)

  @@unique([evaluationId, submissionProblemId])
}
